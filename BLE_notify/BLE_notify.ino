#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <ArduinoJson.h>


#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define SERVICE_UUID        "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHARACTERISTIC_UUID "beb5483e-36e1-4688-b7f5-ea07361b26a8"


// 'left', 40x40px
const unsigned char epd_bitmap_left [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xff, 
	0xe0, 0x7f, 0xff, 0xff, 0xff, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0x80, 0xff, 0xff, 0xff, 0xff, 0x01, 
	0xff, 0xff, 0xff, 0xfe, 0x03, 0xff, 0xff, 0xff, 0xfc, 0x07, 0xff, 0xff, 0xff, 0xf8, 0x0f, 0xff, 
	0xff, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0xe0, 0x1f, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 
	0x3f, 0x80, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x03, 
	0xc0, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x1f, 0xff, 0xff, 0x01, 0xf0, 0x0f, 0xff, 0xff, 0xc0, 0xf8, 
	0x07, 0xff, 0xff, 0xc0, 0xfc, 0x03, 0xff, 0xff, 0xe0, 0xfe, 0x01, 0xff, 0xff, 0xe0, 0xff, 0x00, 
	0xff, 0xff, 0xe0, 0xff, 0x80, 0x7f, 0xff, 0xe0, 0xff, 0xc0, 0x7f, 0xff, 0xe0, 0xff, 0xe0, 0x7f, 
	0xff, 0xe0, 0xff, 0xf0, 0xff, 0xff, 0xe0, 0xff, 0xfd, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 
	0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 
	0xff, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xff, 
	0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 
	0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xf0
};
// 'right', 40x40px
const unsigned char epd_bitmap_right [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 
	0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x80, 0xff, 0xff, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 
	0xff, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xe0, 0x1f, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xff, 
	0xf8, 0x07, 0xff, 0xff, 0xff, 0xfc, 0x03, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xff, 0x00, 0x00, 0x00, 
	0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 
	0xe0, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x7f, 0xff, 0xfe, 0x03, 0xc0, 0xff, 0xff, 0xfc, 0x07, 0xc1, 
	0xff, 0xff, 0xf8, 0x0f, 0x81, 0xff, 0xff, 0xf0, 0x1f, 0x81, 0xff, 0xff, 0xe0, 0x3f, 0x81, 0xff, 
	0xff, 0xc0, 0x7f, 0x81, 0xff, 0xff, 0x80, 0xff, 0x81, 0xff, 0xff, 0x81, 0xff, 0x81, 0xff, 0xff, 
	0x83, 0xff, 0x81, 0xff, 0xff, 0x87, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 
	0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 
	0x81, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x81, 
	0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 
	0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff
};
// 'sharpleft', 40x40px
const unsigned char epd_bitmap_sharpleft [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xff, 0xfe, 0x07, 0xff, 
	0xff, 0xff, 0xf8, 0x03, 0xff, 0xff, 0xff, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xe0, 0x03, 0xff, 0xff, 
	0xff, 0xc0, 0x03, 0xff, 0xff, 0xff, 0x80, 0x03, 0xff, 0xff, 0xff, 0x00, 0x03, 0xff, 0xff, 0xfe, 
	0x01, 0x83, 0xff, 0xff, 0xfc, 0x03, 0x83, 0xff, 0xff, 0xf8, 0x07, 0x83, 0xff, 0xff, 0xf0, 0x0f, 
	0x83, 0xff, 0xff, 0xe0, 0x1f, 0x83, 0xff, 0xff, 0xc0, 0x3f, 0x83, 0xf3, 0xff, 0x80, 0x7f, 0x83, 
	0xe1, 0xff, 0x00, 0xff, 0x83, 0xc1, 0xfe, 0x01, 0xff, 0x83, 0xc0, 0xfc, 0x03, 0xff, 0x83, 0xc0, 
	0xf8, 0x07, 0xff, 0x83, 0xc0, 0xf0, 0x0f, 0xff, 0x83, 0xc0, 0xe0, 0x1f, 0xff, 0x83, 0xc0, 0xc0, 
	0x3f, 0xff, 0x83, 0xc0, 0x80, 0x7f, 0xff, 0x83, 0xc0, 0x00, 0xff, 0xff, 0x83, 0xc0, 0x01, 0xff, 
	0xff, 0x83, 0xc0, 0x03, 0xff, 0xff, 0x83, 0xc0, 0x07, 0xff, 0xff, 0x83, 0xc0, 0x0f, 0xff, 0xff, 
	0x83, 0xc0, 0x00, 0x0f, 0xff, 0x83, 0xc0, 0x00, 0x07, 0xff, 0x83, 0xc0, 0x00, 0x03, 0xff, 0x83, 
	0xc0, 0x00, 0x03, 0xff, 0x83, 0xc0, 0x00, 0x07, 0xff, 0x83, 0xe0, 0x00, 0x0f, 0xff, 0x83, 0xff, 
	0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 
	0xff, 0xff, 0x83, 0xff, 0xff, 0xff, 0xff, 0xc3
};
// 'sharpright', 40x40px
const unsigned char epd_bitmap_sharpright [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x3f, 0xff, 0xff, 0xff, 0xe0, 
	0x1f, 0xff, 0xff, 0xff, 0xc0, 0x0f, 0xff, 0xff, 0xff, 0xc0, 0x07, 0xff, 0xff, 0xff, 0xc0, 0x03, 
	0xff, 0xff, 0xff, 0xc0, 0x01, 0xff, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0xff, 0xc0, 0x80, 0x7f, 
	0xff, 0xff, 0xc0, 0xc0, 0x3f, 0xff, 0xff, 0xc0, 0xe0, 0x1f, 0xff, 0xff, 0xc0, 0xf0, 0x0f, 0xff, 
	0xff, 0xc0, 0xf8, 0x07, 0xff, 0xff, 0xc0, 0xfc, 0x03, 0xff, 0xff, 0xc0, 0xfe, 0x01, 0xff, 0xe7, 
	0xc0, 0xff, 0x00, 0xff, 0x83, 0xc0, 0xff, 0x80, 0x7f, 0x83, 0xc0, 0xff, 0xc0, 0x3f, 0x83, 0xc0, 
	0xff, 0xe0, 0x1f, 0x83, 0xc0, 0xff, 0xf0, 0x0f, 0x83, 0xc0, 0xff, 0xf8, 0x07, 0x83, 0xc0, 0xff, 
	0xfc, 0x03, 0x83, 0xc0, 0xff, 0xfe, 0x01, 0x83, 0xc0, 0xff, 0xff, 0x00, 0x83, 0xc0, 0xff, 0xff, 
	0x80, 0x03, 0xc0, 0xff, 0xff, 0xc0, 0x03, 0xc0, 0xff, 0xff, 0xe0, 0x03, 0xc0, 0xff, 0xff, 0xf0, 
	0x03, 0xc0, 0xff, 0xf0, 0x00, 0x03, 0xc0, 0xff, 0xe0, 0x00, 0x03, 0xc0, 0xff, 0xe0, 0x00, 0x03, 
	0xc0, 0xff, 0xe0, 0x00, 0x03, 0xc0, 0xff, 0xe0, 0x00, 0x03, 0xc0, 0xff, 0xf0, 0x00, 0x07, 0xc0, 
	0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 
	0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff
};
// 'slightleft', 40x40px
const unsigned char epd_bitmap_slightleft [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xff, 0x80, 0x01, 0xff, 0xff, 0xff, 
	0x80, 0x01, 0xff, 0xff, 0xff, 0x80, 0x03, 0xff, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xff, 0x80, 
	0x3f, 0xff, 0xff, 0xff, 0x80, 0x3f, 0xff, 0xff, 0xff, 0x84, 0x0f, 0xff, 0xff, 0xff, 0x86, 0x07, 
	0xff, 0xff, 0xff, 0x87, 0x03, 0xff, 0xff, 0xff, 0x87, 0x81, 0xff, 0xff, 0xff, 0x87, 0xc0, 0xff, 
	0xff, 0xff, 0x87, 0xe0, 0x7f, 0xff, 0xff, 0xcf, 0xf0, 0x7f, 0xff, 0xff, 0xff, 0xf8, 0x1f, 0xff, 
	0xff, 0xff, 0xfc, 0x0f, 0xff, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xff, 0xff, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0x83, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 
	0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 
	0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 
	0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 
	0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 
	0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 
	0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff
};
// 'slightright', 40x40px
const unsigned char epd_bitmap_slightright [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xff, 0x80, 0x01, 0xff, 0xff, 
	0xff, 0x80, 0x01, 0xff, 0xff, 0xff, 0xc0, 0x01, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xff, 0xff, 0xff, 
	0xfc, 0x01, 0xff, 0xff, 0xff, 0xf8, 0x01, 0xff, 0xff, 0xff, 0xf0, 0x21, 0xff, 0xff, 0xff, 0xe0, 
	0x61, 0xff, 0xff, 0xff, 0xc0, 0xe1, 0xff, 0xff, 0xff, 0x81, 0xe1, 0xff, 0xff, 0xff, 0x03, 0xe1, 
	0xff, 0xff, 0xfe, 0x07, 0xe1, 0xff, 0xff, 0xfc, 0x0f, 0xf3, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 
	0xff, 0xf0, 0x3f, 0xff, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 
	0xc1, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0x87, 
	0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 
	0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 
	0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 
	0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 
	0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0x87, 
	0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff
};
// 'straight', 40x40px
const unsigned char epd_bitmap_straight [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 
	0xff, 0x80, 0xff, 0xff, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0xfe, 0x00, 0x3f, 0xff, 0xff, 0xfc, 
	0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x0f, 0xff, 0xff, 0xf0, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 
	0x03, 0xff, 0xff, 0xc0, 0x41, 0x01, 0xff, 0xff, 0x80, 0xc1, 0x80, 0xff, 0xff, 0x01, 0xc1, 0xc0, 
	0x7f, 0xff, 0x03, 0xc1, 0xe0, 0x7f, 0xff, 0x07, 0xc1, 0xf0, 0x7f, 0xff, 0x8f, 0xc1, 0xf8, 0xff, 
	0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 
	0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 
	0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 
	0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 
	0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 
	0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 
	0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 
	0xc1, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff
};
// 'uturn', 40x40px
const unsigned char epd_bitmap_uturn [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x07, 0xff, 0xff, 0xff, 0xe0, 0x01, 0xff, 0xff, 0xff, 
	0xc0, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x3f, 0xff, 0xff, 0x00, 0xc0, 0x3f, 0xff, 0xfe, 0x07, 
	0xf8, 0x1f, 0xff, 0xfc, 0x0f, 0xfc, 0x0f, 0xff, 0xfc, 0x1f, 0xfe, 0x0f, 0xff, 0xf8, 0x3f, 0xff, 
	0x0f, 0xff, 0xf8, 0x3f, 0xff, 0x07, 0xff, 0xf8, 0x3f, 0xff, 0x07, 0xff, 0xf8, 0x7f, 0xff, 0x87, 
	0xff, 0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 0xff, 0x87, 0xff, 
	0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 
	0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 
	0xff, 0x87, 0xff, 0xf8, 0x7f, 0xe3, 0x87, 0x1f, 0xf8, 0x7f, 0xc1, 0x86, 0x1f, 0xf8, 0x7f, 0xc0, 
	0x84, 0x1f, 0xf8, 0x7f, 0xe0, 0x00, 0x1f, 0xf8, 0x7f, 0xf0, 0x00, 0x3f, 0xf8, 0x7f, 0xf8, 0x00, 
	0x7f, 0xf8, 0x7f, 0xfc, 0x00, 0xff, 0xf8, 0x7f, 0xfe, 0x01, 0xff, 0xf8, 0x7f, 0xff, 0x03, 0xff, 
	0xf8, 0x7f, 0xff, 0x87, 0xff, 0xf8, 0x7f, 0xff, 0xcf, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xf8, 
	0x7f, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xf8, 0x7f, 
	0xff, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xff
};

// Define the struct
struct BitmapDict {
    const char* key;
    const unsigned char* bitmap;
};


// Create the dictionary
BitmapDict bitmapDictionary[] = {
    { "left", epd_bitmap_left },
    { "right", epd_bitmap_right },
    { "straight", epd_bitmap_straight },
    { "slight left", epd_bitmap_slightleft },
    { "slight right", epd_bitmap_slightright },
    { "sharp left", epd_bitmap_sharpleft },
    { "sharp right", epd_bitmap_sharpright },
    { "uturn", epd_bitmap_uturn },
};

// Number of items in the dictionary
const int dictSize = sizeof(bitmapDictionary) / sizeof(bitmapDictionary[0]);

// Function to retrieve a bitmap by key
const unsigned char* getBitmap(const char* direction) {
    for (int i = 0; i < dictSize; i++) {
        if (strcmp(bitmapDictionary[i].key, direction) == 0) {
            return bitmapDictionary[i].bitmap;
        }
    }
    return nullptr; // Return null if not found
}

// OLED display setup
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

BLEServer* pServer = NULL;
BLECharacteristic* pCharacteristic = NULL;
bool deviceConnected = false;
bool oldDeviceConnected = false;
String receivedMessage = ""; // Store the received Bluetooth message
uint32_t value = 0;

class MyServerCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) {
        deviceConnected = true;
    }

    void onDisconnect(BLEServer* pServer) {
        deviceConnected = false;
    }
};

class MyCallbacks: public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic *pCharacteristic) {
        std::string value = pCharacteristic->getValue().c_str();

        if (value.length() > 0) {
            receivedMessage = ""; // Clear previous message
            for (int i = 0; i < value.length(); i++) {
                receivedMessage += value[i]; // Append each character to receivedMessage
            }
            Serial.print("Received Value: ");
            Serial.println(receivedMessage);

            JsonDocument doc;
            DeserializationError error = deserializeJson(doc, receivedMessage);
            
            display.clearDisplay();
            if (error) {
              Serial.print(F("deserializeJson() failed: "));
              Serial.println(error.f_str());
              display.println("deserializeJson() failed: ");
            }else{
              const char* turn = doc["turn"];
              const char* distance = doc["distance"];

              const unsigned char* bitmap = getBitmap(turn);
              // Display the new message on the OLED
              display.drawBitmap(0, 0,  bitmap, 40, 40, WHITE);
              display.setTextColor(WHITE);
              display.setCursor(0, 42);
              display.setTextSize(1.6);
              // display.println(turn); 
              display.println(distance);
            }

            display.display();
        }
    }
};

void setup() {
    Serial.begin(115200);

    // Initialize OLED display
    if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
        Serial.println(F("SSD1306 allocation failed"));
        for (;;);
    }
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(WHITE);
    display.setCursor(0, 10);
    display.println("Waiting for BLE...");
    display.display();

    // Initialize BLE
    BLEDevice::init("Smart Helmet");
    pServer = BLEDevice::createServer();
    pServer->setCallbacks(new MyServerCallbacks());
    BLEService *pService = pServer->createService(SERVICE_UUID);
    pCharacteristic = pService->createCharacteristic(
                        CHARACTERISTIC_UUID,
                        BLECharacteristic::PROPERTY_READ   |
                        BLECharacteristic::PROPERTY_WRITE  |
                        BLECharacteristic::PROPERTY_NOTIFY |
                        BLECharacteristic::PROPERTY_INDICATE
                      );
    pCharacteristic->setCallbacks(new MyCallbacks());
    pCharacteristic->addDescriptor(new BLE2902());
    pService->start();
    
    // Start advertising
    BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
    pAdvertising->addServiceUUID(SERVICE_UUID);
    pAdvertising->setScanResponse(false);
    pAdvertising->setMinPreferred(0x0);
    BLEDevice::startAdvertising();
    Serial.println("Waiting for a client connection to notify...");
}

void loop() {
    if (deviceConnected) {
        pCharacteristic->setValue((uint8_t*)&value, 4);
        pCharacteristic->notify();
        value++;
        delay(500);
    }
    // disconnecting
    if (!deviceConnected && oldDeviceConnected) {
        delay(500); // give the bluetooth stack the chance to get things ready
        pServer->startAdvertising(); // restart advertising
        Serial.println("start advertising");
        display.clearDisplay();
        display.setTextSize(1);
        display.setTextColor(WHITE);
        display.setCursor(0, 10);
        display.println("Start Advertising");
        display.display();
        oldDeviceConnected = deviceConnected;
    }
    // connecting
    if (deviceConnected && !oldDeviceConnected) {
        // do stuff here on connecting
        oldDeviceConnected = deviceConnected;
        display.println("Set Your Destination...");
    }
}
